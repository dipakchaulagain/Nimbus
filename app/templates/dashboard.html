{% extends 'base.html' %}

{% block title %}Dashboard - Nimbus VM Inventory{% endblock %}

{% block content %}
<!-- Enhanced Header Section -->
<div class="d-flex align-items-center justify-content-between mb-4">
  <div class="d-flex align-items-center">
    <div class="me-3">
      <div class="bg-primary rounded-3 p-3 d-flex align-items-center justify-content-center" style="background: var(--primary-gradient) !important; width: 48px; height: 48px;">
        <i class="bi bi-speedometer2 text-white fs-5"></i>
      </div>
    </div>
    <div>
      <h2 class="mb-1 fw-bold">Dashboard</h2>
      <p class="text-muted mb-0">Overview of your virtual machine infrastructure</p>
    </div>
  </div>
  <div class="btn-group">
    <button class="btn btn-outline-primary btn-lg" onclick="refreshData()">
      <i class="bi bi-arrow-clockwise me-2"></i>Refresh
    </button>
    <div class="dropdown">
      <button class="btn btn-outline-secondary btn-lg dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-download me-2"></i>Export
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="/reports/summary"><i class="bi bi-file-earmark-text me-2"></i>Summary Report</a></li>
        <li><a class="dropdown-item" href="/reports/detailed"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Detailed Report</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="/reports/custom"><i class="bi bi-gear me-2"></i>Custom Report</a></li>
      </ul>
    </div>
  </div>
</div>

<!-- Enhanced Statistics Cards -->
<div class="row mb-5">
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-0 h-100 stats-card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="bg-primary rounded-3 p-2" style="background: var(--primary-gradient) !important;">
              <i class="bi bi-hdd-network text-white"></i>
            </div>
          </div>
          <div class="ms-3 flex-grow-1">
            <div class="fw-bold fs-5 counter" id="total-vms" data-target="0">0</div>
            <div class="text-muted small">Total VMs</div>
          </div>
        </div>
        <div class="d-flex align-items-center mt-3">
          <span class="badge rounded-pill px-3 py-2" style="background: var(--success-gradient); color: white;">
            <i class="bi bi-arrow-up small me-1"></i>Live Data
          </span>
          <small class="text-muted ms-2">Real-time stats</small>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-0 h-100 stats-card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="bg-success rounded-3 p-2" style="background: var(--success-gradient) !important;">
              <i class="bi bi-toggle-on text-white"></i>
            </div>
          </div>
          <div class="ms-3 flex-grow-1">
            <div class="fw-bold fs-5 counter" id="powered-on" data-target="0">0</div>
            <div class="text-muted small">Powered On</div>
          </div>
        </div>
        <div class="d-flex align-items-center mt-3">
          <div class="progress flex-grow-1 me-2" style="height: 6px;">
            <div class="progress-bar" id="powered-on-progress" style="background: var(--success-gradient); width: 0%"></div>
          </div>
          <small class="text-muted" id="powered-on-percentage">0%</small>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-0 h-100 stats-card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="bg-secondary rounded-3 p-2">
              <i class="bi bi-toggle-off text-white"></i>
            </div>
          </div>
          <div class="ms-3 flex-grow-1">
            <div class="fw-bold fs-5 counter" id="powered-off" data-target="0">0</div>
            <div class="text-muted small">Powered Off</div>
          </div>
        </div>
        <div class="d-flex align-items-center mt-3">
          <div class="progress flex-grow-1 me-2" style="height: 6px;">
            <div class="progress-bar bg-secondary" id="powered-off-progress" style="width: 0%"></div>
          </div>
          <small class="text-muted" id="powered-off-percentage">0%</small>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-0 h-100 stats-card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="bg-info rounded-3 p-2" style="background: var(--info-gradient) !important;">
              <i class="bi bi-server text-white"></i>
            </div>
          </div>
          <div class="ms-3 flex-grow-1">
            <div class="fw-bold fs-5 counter" id="total-hypervisors" data-target="0">0</div>
            <div class="text-muted small">Hypervisors</div>
          </div>
        </div>
        <div class="d-flex align-items-center mt-3">
          <span class="badge rounded-pill px-3 py-2" style="background: var(--info-gradient); color: white;">
            <i class="bi bi-check-circle small me-1"></i>Connected
          </span>
          <small class="text-muted ms-2">vCenter systems</small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- OS Breakdown Statistics -->
<div class="row mb-5">
  <div class="col-12">
    <div class="card border-0">
      <div class="card-header bg-white border-bottom-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1 fw-semibold">
              <i class="bi bi-pie-chart me-2 text-primary"></i>
              VM Operating System Breakdown
            </h5>
            <small class="text-muted">Distribution by OS type and power state</small>
          </div>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="refreshVMStats()"><i class="bi bi-arrow-clockwise me-2"></i>Refresh</a></li>
              <li><a class="dropdown-item" href="/vms/"><i class="bi bi-eye me-2"></i>View All VMs</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <!-- Windows VMs -->
          <div class="col-lg-4 col-md-6">
            <div class="os-stat-card p-4 rounded-3 h-100" style="background: linear-gradient(135deg, rgba(0, 123, 255, 0.1) 0%, rgba(0, 123, 255, 0.05) 100%); border-left: 4px solid #007bff;">
              <div class="d-flex align-items-center mb-3">
                <div class="bg-primary rounded-3 d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                  <i class="bi bi-windows text-white fs-4"></i>
                </div>
                <div>
                  <h6 class="mb-1 fw-bold">Windows</h6>
                  <div class="fw-bold fs-4 text-primary" id="windows-total">0</div>
                </div>
              </div>
              <div class="row text-center">
                <div class="col-6">
                  <div class="fw-bold text-success" id="windows-on">0</div>
                  <small class="text-muted">Powered On</small>
                </div>
                <div class="col-6">
                  <div class="fw-bold text-secondary" id="windows-off">0</div>
                  <small class="text-muted">Powered Off</small>
                </div>
              </div>
              <div class="progress mt-3" style="height: 6px;">
                <div class="progress-bar bg-success" id="windows-on-bar" style="width: 0%"></div>
                <div class="progress-bar bg-secondary" id="windows-off-bar" style="width: 0%"></div>
              </div>
            </div>
          </div>
          
          <!-- Linux VMs -->
          <div class="col-lg-4 col-md-6">
            <div class="os-stat-card p-4 rounded-3 h-100" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%); border-left: 4px solid #28a745;">
              <div class="d-flex align-items-center mb-3">
                <div class="bg-success rounded-3 d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                  <i class="bi bi-terminal text-white fs-4"></i>
                </div>
                <div>
                  <h6 class="mb-1 fw-bold">Linux</h6>
                  <div class="fw-bold fs-4 text-success" id="linux-total">0</div>
                </div>
              </div>
              <div class="row text-center">
                <div class="col-6">
                  <div class="fw-bold text-success" id="linux-on">0</div>
                  <small class="text-muted">Powered On</small>
                </div>
                <div class="col-6">
                  <div class="fw-bold text-secondary" id="linux-off">0</div>
                  <small class="text-muted">Powered Off</small>
                </div>
              </div>
              <div class="progress mt-3" style="height: 6px;">
                <div class="progress-bar bg-success" id="linux-on-bar" style="width: 0%"></div>
                <div class="progress-bar bg-secondary" id="linux-off-bar" style="width: 0%"></div>
              </div>
            </div>
          </div>
          
          <!-- Other OS VMs -->
          <div class="col-lg-4 col-md-6">
            <div class="os-stat-card p-4 rounded-3 h-100" style="background: linear-gradient(135deg, rgba(108, 117, 125, 0.1) 0%, rgba(108, 117, 125, 0.05) 100%); border-left: 4px solid #6c757d;">
              <div class="d-flex align-items-center mb-3">
                <div class="bg-secondary rounded-3 d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                  <i class="bi bi-question-circle text-white fs-4"></i>
                </div>
                <div>
                  <h6 class="mb-1 fw-bold">Other</h6>
                  <div class="fw-bold fs-4 text-secondary" id="other-total">0</div>
                </div>
              </div>
              <div class="row text-center">
                <div class="col-6">
                  <div class="fw-bold text-success" id="other-on">0</div>
                  <small class="text-muted">Powered On</small>
                </div>
                <div class="col-6">
                  <div class="fw-bold text-secondary" id="other-off">0</div>
                  <small class="text-muted">Powered Off</small>
                </div>
              </div>
              <div class="progress mt-3" style="height: 6px;">
                <div class="progress-bar bg-success" id="other-on-bar" style="width: 0%"></div>
                <div class="progress-bar bg-secondary" id="other-off-bar" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Enhanced Quick Actions Card -->
  <div class="col-lg-6">
    <div class="card border-0 h-100">
      <div class="card-header bg-white border-bottom-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1 fw-semibold">
              <i class="bi bi-lightning me-2 text-primary"></i>
              Quick Actions
            </h5>
            <small class="text-muted">Frequently used management tasks</small>
          </div>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Customize</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-sliders me-2"></i>Settings</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-6">
            <a href="/vms/" class="text-decoration-none">
              <div class="quick-action-card p-4 rounded-3 text-center h-100">
                <div class="bg-primary rounded-3 d-inline-flex align-items-center justify-content-center mb-3" style="width: 50px; height: 50px; background: var(--primary-gradient) !important;">
                  <i class="bi bi-hdd-network fs-4 text-white"></i>
                </div>
                <h6 class="fw-semibold mb-1">View VMs</h6>
                <small class="text-muted">Manage virtual machines</small>
              </div>
            </a>
          </div>
          <div class="col-6">
            <a href="/vcenter/" class="text-decoration-none">
              <div class="quick-action-card p-4 rounded-3 text-center h-100">
                <div class="bg-success rounded-3 d-inline-flex align-items-center justify-content-center mb-3" style="width: 50px; height: 50px; background: var(--success-gradient) !important;">
                  <i class="bi bi-server fs-4 text-white"></i>
                </div>
                <h6 class="fw-semibold mb-1">vCenter</h6>
                <small class="text-muted">vCenter management</small>
              </div>
            </a>
          </div>
          <div class="col-6">
            <a href="/owners/" class="text-decoration-none">
              <div class="quick-action-card p-4 rounded-3 text-center h-100">
                <div class="bg-info rounded-3 d-inline-flex align-items-center justify-content-center mb-3" style="width: 50px; height: 50px; background: var(--info-gradient) !important;">
                  <i class="bi bi-people fs-4 text-white"></i>
                </div>
                <h6 class="fw-semibold mb-1">Owners</h6>
                <small class="text-muted">Manage VM owners</small>
              </div>
            </a>
          </div>
          <div class="col-6">
            <a href="/tags/" class="text-decoration-none">
              <div class="quick-action-card p-4 rounded-3 text-center h-100">
                <div class="bg-warning rounded-3 d-inline-flex align-items-center justify-content-center mb-3" style="width: 50px; height: 50px; background: var(--warning-gradient) !important;">
                  <i class="bi bi-tags fs-4 text-white"></i>
                </div>
                <h6 class="fw-semibold mb-1">Tags</h6>
                <small class="text-muted">Organize with tags</small>
              </div>
            </a>
          </div>
        </div>
        <div class="mt-4">
          <a href="/admins/" class="btn btn-primary w-100 btn-lg">
            <i class="bi bi-shield-check me-2"></i>
            Admin Management
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- VM Management Summary Card -->
  <div class="col-lg-6">
    <div class="card border-0 h-100">
      <div class="card-header bg-white border-bottom-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1 fw-semibold">
              <i class="bi bi-graph-up me-2 text-primary"></i>
              VM Management Summary
            </h5>
            <small class="text-muted">Overview of VM operations</small>
          </div>
          <span class="badge rounded-pill px-3 py-2" style="background: var(--success-gradient); color: white;">
            <i class="bi bi-check-circle me-1"></i>System Healthy
          </span>
        </div>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-6">
            <div class="text-center p-3 rounded-3" style="background: rgba(40, 167, 69, 0.1);">
              <div class="fw-bold fs-4 text-success" id="avg-cpu">0</div>
              <small class="text-muted">Avg CPU Cores</small>
              </div>
              </div>
          <div class="col-6">
            <div class="text-center p-3 rounded-3" style="background: rgba(0, 123, 255, 0.1);">
              <div class="fw-bold fs-4 text-primary" id="avg-memory">0</div>
              <small class="text-muted">Avg Memory (GB)</small>
            </div>
              </div>
          <div class="col-6">
            <div class="text-center p-3 rounded-3" style="background: rgba(255, 193, 7, 0.1);">
              <div class="fw-bold fs-4 text-warning" id="total-owners">0</div>
              <small class="text-muted">Active Owners</small>
            </div>
          </div>
          <div class="col-6">
            <div class="text-center p-3 rounded-3" style="background: rgba(108, 117, 125, 0.1);">
              <div class="fw-bold fs-4 text-secondary" id="total-tags">0</div>
              <small class="text-muted">VM Tags</small>
              </div>
            </div>
          </div>
          
        <div class="border-top pt-3 mt-3">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
              <i class="bi bi-clock me-1"></i>Last updated:
            </small>
            <small class="fw-semibold" id="lastUpdated">Just now</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recent Audit Logs -->
<div class="row g-4 mt-2">
  <div class="col-12">
    <div class="card border-0">
      <div class="card-header bg-white border-bottom-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1 fw-semibold">
              <i class="bi bi-clock-history me-2 text-primary"></i>
              Recent Activity
            </h5>
            <small class="text-muted">Latest audit logs and system events</small>
          </div>
          <a href="/audit/" class="btn btn-outline-primary btn-lg">
            <i class="bi bi-eye me-2"></i>View All Logs
          </a>
        </div>
      </div>
      <div class="card-body">
        <div id="audit-feed" class="audit-feed">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-2">Loading recent activity...</p>
          </div>
        </div>
        
        <div class="text-center mt-4 pt-3 border-top">
          <small class="text-muted">
            <i class="bi bi-arrow-clockwise me-1"></i>
            Activity feed updates every 5 minutes
          </small>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --info-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    --danger-gradient: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
  }

  .stats-card {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  }
  
  .stats-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-gradient);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }
  
  .stats-card:hover::before {
    opacity: 1;
  }
  
  .quick-action-card {
    transition: all 0.3s ease;
    border: 1px solid transparent;
    background-color: #f8f9fa;
    position: relative;
    overflow: hidden;
  }
  
  .quick-action-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s;
  }
  
  .quick-action-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: var(--bs-border-color);
    background-color: white;
  }
  
  .quick-action-card:hover::before {
    left: 100%;
  }
  
  .activity-item {
    padding: 20px 0;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    transition: background-color 0.2s ease;
  }
  
  .activity-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }
  
  .activity-item:hover {
    background-color: rgba(0,0,0,0.02);
    border-radius: 8px;
    padding-left: 12px;
    padding-right: 12px;
  }
  
  .counter {
    color: #2d3748;
  }

  .alert {
    border-radius: 12px;
    transition: all 0.3s ease;
  }

  .alert:hover {
    transform: translateX(4px);
  }

  .progress {
    border-radius: 6px;
    background-color: rgba(0,0,0,0.1);
  }

  .progress-bar {
    border-radius: 6px;
  }

  .card {
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
  }

  .card:hover {
    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
  }

  .btn-lg {
    padding: 12px 24px;
    font-weight: 600;
  }

  .loading {
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .os-stat-card {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .os-stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }

  .os-stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
  }

  .os-stat-card:hover::before {
    left: 100%;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
let vmStatsData = null;

// Function to fetch VM statistics from API
async function fetchVMStats() {
  try {
    const response = await fetch('/vms/api/stats');
    if (!response.ok) {
      throw new Error('Failed to fetch VM statistics');
    }
    vmStatsData = await response.json();
    updateDashboardStats();
  } catch (error) {
    console.error('Error fetching VM stats:', error);
    showToast('danger', 'Failed to load VM statistics');
  }
}

// Function to update dashboard with VM statistics
function updateDashboardStats() {
  if (!vmStatsData) return;

  // Update main statistics cards
  updateCounter('#total-vms', vmStatsData.total_vms);
  updateCounter('#powered-on', vmStatsData.power_stats.powered_on);
  updateCounter('#powered-off', vmStatsData.power_stats.powered_off);

  // Update percentages
  const totalVMs = vmStatsData.total_vms;
  const poweredOn = vmStatsData.power_stats.powered_on;
  const poweredOff = vmStatsData.power_stats.powered_off;

  if (totalVMs > 0) {
    const poweredOnPercent = ((poweredOn / totalVMs) * 100).toFixed(1);
    const poweredOffPercent = ((poweredOff / totalVMs) * 100).toFixed(1);

    $('#powered-on-percentage').text(poweredOnPercent + '%');
    $('#powered-off-percentage').text(poweredOffPercent + '%');
    $('#powered-on-progress').css('width', poweredOnPercent + '%');
    $('#powered-off-progress').css('width', poweredOffPercent + '%');
  }

  // Update OS breakdown
  updateOSStats('windows', vmStatsData.os_breakdown.windows);
  updateOSStats('linux', vmStatsData.os_breakdown.linux);
  updateOSStats('other', vmStatsData.os_breakdown.other);

  // Update additional metrics if available
  if (vmStatsData.additional_metrics) {
    updateCounter('#avg-cpu', vmStatsData.additional_metrics.avg_cpu || 0);
    updateCounter('#avg-memory', Math.round(vmStatsData.additional_metrics.avg_memory_gb || 0));
    updateCounter('#total-owners', vmStatsData.additional_metrics.total_owners || 0);
    updateCounter('#total-tags', vmStatsData.additional_metrics.total_tags || 0);
    updateCounter('#total-hypervisors', vmStatsData.additional_metrics.unique_hypervisors || 0);
  }
}

// Function to update OS statistics
function updateOSStats(osType, stats) {
  updateCounter(`#${osType}-total`, stats.total);
  updateCounter(`#${osType}-on`, stats.powered_on);
  updateCounter(`#${osType}-off`, stats.powered_off);

  // Update progress bars
  if (stats.total > 0) {
    const onPercent = ((stats.powered_on / stats.total) * 100).toFixed(1);
    const offPercent = ((stats.powered_off / stats.total) * 100).toFixed(1);
    
    $(`#${osType}-on-bar`).css('width', onPercent + '%');
    $(`#${osType}-off-bar`).css('width', offPercent + '%');
  }
}

// Enhanced counter animation function
function updateCounter(selector, target) {
  const $element = $(selector);
  const currentValue = parseInt($element.text()) || 0;
  
  $({ countNum: currentValue }).animate({
      countNum: target
    }, {
    duration: 1500,
      easing: 'easeOutCubic',
      step: function() {
      $element.text(Math.floor(this.countNum));
      },
      complete: function() {
      $element.text(target.toLocaleString());
    }
  });
}

// Global function to refresh VM stats
window.refreshVMStats = function() {
  fetchVMStats();
};

$(document).ready(function() {
  // Load VM statistics on page load
  fetchVMStats();
  
  // Set up auto-refresh every 2 minutes
  setInterval(fetchVMStats, 120000);
  
  // Update timestamp with more realistic intervals
  function updateTimestamp() {
    const now = new Date();
    $('#lastUpdated').text(now.toLocaleTimeString());
    
    setTimeout(() => {
      $('#lastUpdated').text('1 minute ago');
    }, 60000);
  }
  
  updateTimestamp();
  setInterval(updateTimestamp, 300000); // Update every 5 minutes
  
  // Enhanced refresh data function
  window.refreshData = function() {
    const btn = $('button:contains("Refresh")');
    const originalHtml = btn.html();
    
    btn.html('<div class="loading me-2"></div>Refreshing...').prop('disabled', true);
    
    // Refresh VM stats and audit logs
    Promise.all([
      fetchVMStats(),
      fetchRecentAuditLogs()
    ]).then(() => {
      btn.html(originalHtml).prop('disabled', false);
      updateTimestamp();
      showToast('success', 'Dashboard data refreshed successfully');
    }).catch(() => {
      btn.html(originalHtml).prop('disabled', false);
      showToast('danger', 'Some data failed to refresh');
    });
  };

  // Function to fetch recent audit logs
  async function fetchRecentAuditLogs() {
    try {
      const response = await fetch('/audit/api/recent');
      if (!response.ok) {
        throw new Error('Failed to fetch audit logs');
      }
      const logs = await response.json();
      updateAuditFeed(logs);
    } catch (error) {
      console.error('Error fetching audit logs:', error);
      $('#audit-feed').html(`
        <div class="text-center py-4">
          <i class="bi bi-exclamation-triangle text-warning display-4 mb-3"></i>
          <h6 class="text-muted">Unable to load recent activity</h6>
          <small class="text-muted">Please try refreshing the page</small>
        </div>
      `);
    }
  }

  // Function to update audit feed
  function updateAuditFeed(logs) {
    if (!logs || logs.length === 0) {
      $('#audit-feed').html(`
        <div class="text-center py-4">
          <i class="bi bi-check-circle text-success display-4 mb-3"></i>
          <h6 class="text-muted">No recent activity</h6>
          <small class="text-muted">System is quiet - no recent changes</small>
        </div>
      `);
      return;
    }

    let html = '';
    logs.slice(0, 5).forEach(log => {
      const timeAgo = new Date(log.timestamp).toLocaleString();
      const iconClass = getActionIcon(log.action);
      const bgClass = getActionBgClass(log.action);
      
      html += `
        <div class="activity-item d-flex align-items-start">
          <div class="${bgClass} rounded-3 d-flex align-items-center justify-content-center me-3" style="width: 36px; height: 36px;">
            <i class="bi ${iconClass} text-white"></i>
          </div>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <p class="mb-1 fw-medium">${log.action.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
              <small class="text-muted">${timeAgo}</small>
            </div>
            <small class="text-muted">${log.details || 'No additional details'}</small>
          </div>
        </div>
      `;
    });
    
    $('#audit-feed').html(html);
  }

  // Helper function to get icon for action type
  function getActionIcon(action) {
    if (action.includes('login')) return 'bi-person-check';
    if (action.includes('vm')) return 'bi-hdd-network';
    if (action.includes('owner')) return 'bi-people';
    if (action.includes('tag')) return 'bi-tags';
    if (action.includes('sync')) return 'bi-arrow-repeat';
    return 'bi-activity';
  }

  // Helper function to get background class for action type
  function getActionBgClass(action) {
    if (action.includes('login')) return 'bg-success';
    if (action.includes('vm')) return 'bg-primary';
    if (action.includes('owner')) return 'bg-info';
    if (action.includes('tag')) return 'bg-warning';
    if (action.includes('sync')) return 'bg-secondary';
    return 'bg-secondary';
  }

  // Toast notification function
  function showToast(type, message) {
    const toastHtml = `
      <div class="toast align-items-center text-bg-${type === 'success' ? 'success' : type === 'info' ? 'info' : 'danger'} border-0" role="alert">
        <div class="d-flex">
          <div class="toast-body">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    `;
    
    let toastContainer = $('.toast-container');
    if (toastContainer.length === 0) {
      $('body').append('<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;"></div>');
      toastContainer = $('.toast-container');
    }
    
    toastContainer.append(toastHtml);
    const toast = new bootstrap.Toast($('.toast').last()[0], { autohide: true, delay: 5000 });
    toast.show();
  }

  // Make showToast available globally
  window.showToast = showToast;

  // Load audit logs on page load
  fetchRecentAuditLogs();
  
  // Set up auto-refresh for audit logs every 5 minutes
  setInterval(fetchRecentAuditLogs, 300000);

  // Enhanced easing function
  $.easing.easeOutCubic = function (x, t, b, c, d) {
    return c*((t=t/d-1)*t*t + 1) + b;
  };

});
</script>
{% endblock %}